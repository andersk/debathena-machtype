#!/usr/bin/make -f

DEB_AUTO_UPDATE_AUTOCONF = 2.50
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/autotools.mk

ATHENA_MAJOR_VERSION = 10
ATHENA_MINOR_VERSION = 0

ARCH_SYSNAMES = $(if $(filter amd64,$(DEB_BUILD_ARCH)),$(1) $(2),$(if $(filter i386,$(DEB_BUILD_ARCH)),$(2),$(error Unrecognized architecture $(DEB_BUILD_ARCH))))

DISTRO = $(shell lsb_release --short --id)
# Ubuntu releases have Debian versions, but not vice-versa
DEBIAN_VERSION = $(shell dpkg-query --showformat='$${Version}' --show base-files)
UBUNTU_VERSION = $(shell lsb_release --short --release)

COMPARE_DEBIAN_VERSION = $(shell dpkg --compare-versions $(DEBIAN_VERSION) '>=' $(1) && echo y)
COMPARE_UBUNTU_VERSION = $(shell dpkg --compare-versions $(UBUNTU_VERSION) '>=' $(1) && echo y)

SYS_COMPAT=

ifneq ($(call COMPARE_DEBIAN_VERSION,3.1),y)
    $(error Debian version $(DEBIAN_VERSION) is too old)
endif

ifeq ($(call COMPARE_DEBIAN_VERSION,4.0.4),y)
    SYS_COMPAT += $(call ARCH_SYSNAMES,amd64_deb50,i386_deb50)
endif

ifeq ($(call COMPARE_DEBIAN_VERSION,4),y)
    SYS_COMPAT += $(call ARCH_SYSNAMES,amd64_deb40,i386_deb40 i386_rhel4)
endif

SYS_COMPAT += i386_rhel3 i386_linux24

ATHENA_SYS = $(word 1, $(SYS_COMPAT))
ATHENA_SYS_COMPAT = $(patsubst %:,%,$(subst : ,:,$(patsubst %,%:,$(wordlist 2, $(words $(SYS_COMPAT)), $(SYS_COMPAT)))))

DEB_CONFIGURE_EXTRA_FLAGS += lbindir=/bin \
	ATHENA_SYS=$(ATHENA_SYS) \
	ATHENA_SYS_COMPAT=$(ATHENA_SYS_COMPAT) \
	ATHENA_MAJOR_VERSION=$(ATHENA_MAJOR_VERSION) \
	ATHENA_MINOR_VERSION=$(ATHENA_MINOR_VERSION)

clean::
	rm -f configure
